{% extends 'Preguntas/home.html' %}

{% block title %}Generar Examen{% endblock %}

{% block content %}
<main class="container my-4">
    <section class="card shadow mb-4">
        <header class="card-header bg-primary text-white py-3">
            <h1 class="h2 mb-0">
                <i class="fas fa-file-alt me-2"></i>Generar Examen
            </h1>
        </header>
        <div class="card-body">

            <!-- Filtros -->
            <section class="card mb-4 border-primary shadow-sm" aria-labelledby="filter-section">
                {% if error %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                    </div>
                {% endif %}
                
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0 d-flex align-items-center" id="filter-section">
                        <i class="fas fa-filter me-2"></i>Filtros de b√∫squeda
                    </h2>
                </div>

                <div class="card-body bg-light">
                    <form method="get" id="filtroForm" class="row g-3">
                        <!-- Universidad -->
                        <div class="col-md-4">
                            <label for="universidad" class="form-label fw-bold">
                                <i class="fas fa-university me-1 text-primary"></i>Universidad
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="fas fa-university"></i>
                                </span>
                                <select name="universidad" id="universidad" class="form-select" aria-label="Filtrar por universidad">
                                    <option value="">Todas las universidades</option>
                                    {% for uni in universidades %}
                                        <option value="{{ uni.id }}" {% if universidad_filter == uni.id|stringformat:"s" %}selected{% endif %}>
                                            {{ uni.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Curso -->
                        <div class="col-md-4">
                            <label for="curso" class="form-label fw-bold">
                                <i class="fas fa-book me-1 text-primary"></i>Curso
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="fas fa-book"></i>
                                </span>
                                <select name="curso" id="curso" class="form-select" aria-label="Filtrar por curso">
                                    <option value="">Todos los cursos</option>
                                    {% for curso in cursos %}
                                        <option value="{{ curso.id }}" {% if curso_filter == curso.id|stringformat:"s" %}selected{% endif %}>
                                            {{ curso.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Tema -->
                        <div class="col-md-4">
                            <label for="tema" class="form-label fw-bold">
                                <i class="fas fa-question-circle me-1 text-primary"></i>Tema
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="fas fa-question-circle"></i>
                                </span>
                                <select name="tema" id="tema" class="form-select" aria-label="Filtrar por tema">
                                    <option value="">Todos los temas</option>
                                    {% for tema in temas %}
                                        <option value="{{ tema.id }}" {% if tema_filter == tema.id|stringformat:"s" %}selected{% endif %}>
                                            {{ tema.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Botones de acci√≥n -->
                        <div class="col-12 mt-4">
                            <div class="row g-2">
                                <!-- Acciones del examen -->
                                <div class="col-lg-8">
                                    <div class="btn-group flex-wrap" role="group" aria-label="Acciones del examen">
                                        <button type="submit" name="add_to_cart" class="btn btn-secondary" form="examenForm" title="A√±adir preguntas seleccionadas al carrito">
                                            <i class="fas fa-cart-plus me-1"></i> A√±adir al Carrito
                                        </button>
                                        <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#carritoModal" title="Ver preguntas en el carrito">
                                            <i class="fas fa-shopping-cart me-1"></i> Ver Carrito 
                                            <span class="badge bg-light text-dark ms-1">{{ carrito.count }}</span>
                                        </button>
                                        <button type="submit" name="download" class="btn btn-success" form="examenForm" title="Descargar examen con preguntas del carrito">
                                            <i class="fas fa-download me-1"></i> Descargar Examen
                                        </button>
                                    </div>
                                </div>

                                <!-- Filtros -->                        
                                <div class="col-lg-4">
                                    <div class="btn-group w-100" role="group" aria-label="Filtros">
                                        <button type="submit" form="filtroForm" class="btn btn-primary" title="Aplicar filtros seleccionados">
                                            <i class="fas fa-filter me-1"></i> Aplicar Filtros
                                        </button>
                                        <a href="{% url 'generar-examen' %}" class="btn btn-outline-secondary" title="Limpiar todos los filtros">
                                            <i class="fas fa-undo me-1"></i> Limpiar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Listado de Preguntas -->
                <form method="post" id="examenForm">
                    {% csrf_token %}

                    <!-- Tabla de preguntas -->
                    <div class="table-responsive mt-3">
                        <table class="table table-striped table-bordered table-hover align-middle">
                            <caption class="visually-hidden">
                                Listado de {{ preguntas.count }} preguntas disponibles
                            </caption>
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-center" style="width: 50px;" scope="col">
                                        <div class="form-check">
                                            <input type="checkbox" id="selectAll" class="form-check-input" aria-label="Seleccionar todas las preguntas">
                                            <label class="form-check-label visually-hidden" for="selectAll">Seleccionar todo</label>
                                        </div>
                                    </th>
                                    <th scope="col">
                                        <i class="fas fa-hashtag me-1"></i>C√≥digo
                                    </th>
                                    <th scope="col">
                                        <i class="fas fa-clock me-1"></i>Estado de Uso
                                    </th>                                  
                                    <th scope="col">
                                        <i class="fas fa-university me-1"></i>Universidad
                                    </th>
                                    <th scope="col">
                                        <i class="fas fa-book me-1"></i>Curso
                                    </th>                                    
                                    <th scope="col">
                                        <i class="fas fa-question-circle me-1"></i>Tema
                                    </th>
                                    <th scope="col">
                                        <i class="fas fa-layer-group me-1"></i>Nivel
                                    </th>                                    
                                    <th class="text-center" scope="col">
                                        <i class="fas fa-calendar me-1"></i>Fecha de Creaci√≥n
                                    </th>
                                    <th class="text-center" style="width: 120px;" scope="col">
                                        <i class="fas fa-cogs me-1"></i>Acciones
                                    </th>
                                    <th scope="col">
                                        <i class="fas fa-check-circle me-1"></i>¬øTiene Soluci√≥n?
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pregunta in preguntas %}
                                    <tr class="{% if pregunta.is_usada %}table-warning{% endif %}">
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" 
                                                    id="pregunta-{{ pregunta.id }}" 
                                                    name="preguntas" 
                                                    value="{{ pregunta.id }}" 
                                                    class="pregunta-checkbox form-check-input" 
                                                    aria-label="Seleccionar pregunta {{ pregunta.nombre }}">
                                                <label class="form-check-label visually-hidden" for="pregunta-{{ pregunta.id }}">
                                                    Seleccionar {{ pregunta.nombre }}
                                                </label>
                                            </div>
                                        </td>
                                        <td>
                                            <strong>{{ pregunta.nombre }}</strong>
                                        </td>
                                        <td>
                                            {% if pregunta.is_usada %}
                                                <span class="badge bg-warning text-dark d-inline-flex align-items-center" 
                                                    title="Pregunta usada en examen previo el {{ pregunta.fecha_ultimo_uso|date:'d/m/Y H:i' }}">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                                    Usada el {{ pregunta.fecha_ultimo_uso|date:"d/m/Y H:i" }}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-success text-white d-inline-flex align-items-center" 
                                                    title="Pregunta no usada en ning√∫n examen">
                                                    <i class="fas fa-check-circle me-1"></i>
                                                    Nueva
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ pregunta.universidad.nombre }}
                                            <small class="text-muted d-block">ID: {{ pregunta.universidad.id }}</small>
                                        </td>
                                        <td>
                                            {{ pregunta.curso.nombre }}
                                            <small class="text-muted d-block">ID: {{ pregunta.curso.id }}</small>
                                        </td>                                        
                                        <td>
                                            {{ pregunta.tema.nombre }}
                                            <small class="text-muted d-block">ID: {{ pregunta.tema.id }}</small>
                                        </td>                                    
                                        <td>
                                            <span class="badge d-inline-flex align-items-center
                                                {% if pregunta.nivel == 1 %}bg-success
                                                {% elif pregunta.nivel == 2 %}bg-warning text-dark
                                                {% elif pregunta.nivel == 3 %}bg-danger
                                                {% else %}bg-secondary{% endif %}">
                                                {% if pregunta.nivel == 1 %}
                                                    <i class="fas fa-signal me-1" style="transform: rotate(45deg);"></i>1 - B√°sico
                                                {% elif pregunta.nivel == 2 %}
                                                    <i class="fas fa-signal me-1"></i>2 - Intermedio
                                                {% elif pregunta.nivel == 3 %}
                                                    <i class="fas fa-signal me-1" style="transform: rotate(-45deg);"></i>3 - Avanzado
                                                {% else %}
                                                    <i class="fas fa-question me-1"></i>Desconocido
                                                {% endif %}
                                            </span>
                                        </td>                                    
                                        <td class="text-center">
                                            <time datetime="{{ pregunta.fecha_creacion|date:'Y-m-d' }}">
                                                {{ pregunta.fecha_creacion|date:"d/m/Y" }}
                                            </time>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group" aria-label="Acciones para {{ pregunta.nombre }}">
                                                <button type="button"
                                                        class="btn btn-info btn-sm"
                                                        data-url="{% url 'vista-previa' pregunta.id %}"
                                                        data-pregunta-id="{{ pregunta.id }}"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#previewModal"
                                                        onclick="loadPdfPreview(this)"
                                                        title="Vista previa de la pregunta">
                                                    <i class="fas fa-eye" aria-hidden="true"></i>
                                                    <span class="visually-hidden">Vista previa</span>
                                                </button>
                                                <a href="{% url 'pregunta-update' pregunta.pk %}" 
                                                class="btn btn-warning btn-sm" 
                                                title="Editar pregunta {{ pregunta.nombre }}" 
                                                aria-label="Editar {{ pregunta.nombre }}">
                                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                                    <span class="visually-hidden">Editar</span>
                                                </a>
                                            </div>
                                        </td>   
                                        <td>
                                            {% if pregunta.tiene_solucion %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check"></i> S√≠
                                                </span>
                                            {% else %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-times"></i> No
                                                </span>
                                            {% endif %}
                                        </td>                                            
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="9" class="text-center py-5">
                                            <div class="text-muted">
                                                <i class="fas fa-search fa-3x mb-3 d-block"></i>
                                                <h3 class="h5">No se encontraron preguntas</h3>
                                                <p class="mb-0">Prueba ajustando los filtros de b√∫squeda o <a href="{% url 'generar-examen' %}" class="text-decoration-none">limpia los filtros</a> para ver todas las preguntas.</p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if preguntas %}
                        <div class="d-flex justify-content-between align-items-center mt-3 p-3 bg-light rounded">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Mostrando {{ preguntas.count }} pregunta{{ preguntas.count|pluralize }} 
                                {% if carrito.count > 0 %}
                                    | {{ carrito.count }} en el carrito
                                {% endif %}
                            </small>
                            <div class="btn-group" role="group">
                                <button type="button" id="selectAllBtn" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-check-square me-1"></i>Seleccionar todo
                                </button>
                                <button type="button" id="deselectAllBtn" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-square me-1"></i>Deseleccionar todo
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </form>
            </section>
        </div>
    </section>
</main>

<!-- Modal de la vista previa en pdf-->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Vista previa de la pregunta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Vista previa en iframe -->
                <iframe id="previewFrame" src="" width="100%" height="700px" frameborder="0"></iframe>
            </div>
            <div class="modal-footer">
                <button id="btnAgregarCarrito" class="btn btn-success">
                    <i class="fas fa-cart-plus me-1"></i>A√±adir al Carrito
                </button>
                <button type="button" class="btn btn-secondary" id="cerrarVistaPreviaBtn">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal del Carrito -->
<div class="modal fade" id="carritoModal" tabindex="-1" aria-labelledby="carritoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-5" id="carritoModalLabel">Carrito de Preguntas</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <ul id="listaCarrito" class="list-group">
                        <li id="pregunta-cart-{{ pregunta.id }}" class="list-group-item d-flex justify-content-between align-items-center">
                            <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Universidad</th>
                                <th>Curso</th>
                                <th>Tema</th>
                                <th>Nivel</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="listaCarrito">
                            {% for pregunta in carrito %}
                            <tr id="pregunta-cart-{{ pregunta.id }}">
                                <td>{{ pregunta.nombre }}</td>
                                <td>{{ pregunta.universidad.nombre }}</td>
                                <td>{{ pregunta.curso.nombre }}</td>
                                <td>{{ pregunta.tema.nombre }}</td>
                                <td>
                                    <span class="badge 
                                        {% if pregunta.nivel == 1 %}bg-success
                                        {% elif pregunta.nivel == 2 %}bg-warning text-dark
                                        {% elif pregunta.nivel == 3 %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {% if pregunta.nivel == 1 %}Bajo
                                        {% elif pregunta.nivel == 2 %}Medio
                                        {% elif pregunta.nivel == 3 %}Alto
                                        {% else %}Desconocido{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button"
                                                class="btn btn-info btn-sm"
                                                data-url="{% url 'vista-previa' pregunta.id %}"
                                                data-pregunta-id="{{ pregunta.id }}"
                                                data-bs-toggle="modal"
                                                data-bs-target="#previewModal"
                                                onclick="loadPdfPreview(this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-danger btn-sm" 
                                                onclick="eliminarPregunta('{{ pregunta.id }}')">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="empty-cart-message">
                                        <i class="fas fa-shopping-cart text-muted mb-2" style="font-size: 2rem;"></i>
                                        <p class="text-muted mb-0">El carrito est√° vac√≠o.</p>
                                        <small class="text-muted">Agrega algunas preguntas para comenzar.</small>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="vaciarCarrito">
                    <i class="fas fa-trash me-1"></i>Vaciar Carrito
                </button>
                <form method="post" id="formCarritoDownload">
                    {% csrf_token %}
                    <input type="hidden" name="download" value="true">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-download me-1"></i>Descargar Examen
                    </button>
                </form>   
                <form method="post" id="formRespuestasDownload">
                    {% csrf_token %}
                    <input type="hidden" name="download_respuestas" value="true">
                    <button type="submit" class="btn btn-outline-success">
                        <i class="fas fa-file-excel me-1"></i>Descargar Respuestas (Excel)
                    </button>
                </form>             
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
// Variable global para almacenar el ID de la pregunta actual en vista previa
let preguntaIdActual = null;

// Funci√≥n para cargar la vista previa del PDF
function loadPdfPreview(button) {
    const url = button.getAttribute('data-url');
    const iframe = document.getElementById('previewFrame');
    iframe.src = url;

    preguntaIdActual = button.getAttribute('data-pregunta-id');

    // üëâ Nuevo: detectar si se abri√≥ desde el carrito
    vistaPreviaDesdeCarrito = button.closest('#carritoModal') !== null;

    const btnAgregarCarrito = document.getElementById("btnAgregarCarrito");
    if (preguntaEnCarrito(preguntaIdActual)) {
        btnAgregarCarrito.disabled = true;
        btnAgregarCarrito.innerHTML = '<i class="fas fa-check me-1"></i> Ya en el carrito';
        btnAgregarCarrito.classList.remove('btn-success');
        btnAgregarCarrito.classList.add('btn-secondary');
    } else {
        btnAgregarCarrito.disabled = false;
        btnAgregarCarrito.innerHTML = '<i class="fas fa-cart-plus me-1"></i> A√±adir al Carrito';
        btnAgregarCarrito.classList.remove('btn-secondary');
        btnAgregarCarrito.classList.add('btn-success');
    }
}


// Funci√≥n para verificar si una pregunta est√° en el carrito
function preguntaEnCarrito(preguntaId) {
    return document.getElementById(`pregunta-cart-${preguntaId}`) !== null;
}

// Funci√≥n para a√±adir pregunta al carrito desde la vista previa
function agregarAlCarritoDesdeVistaPrevia() {
    if (!preguntaIdActual) return;

    const form = document.createElement("form");
    form.method = "POST";
    form.action = window.location.href;

    const csrfInput = document.createElement("input");
    csrfInput.type = "hidden";
    csrfInput.name = "csrfmiddlewaretoken";
    csrfInput.value = "{{ csrf_token }}";

    const preguntaInput = document.createElement("input");
    preguntaInput.type = "hidden";
    preguntaInput.name = "preguntas";
    preguntaInput.value = preguntaIdActual;

    const addToCartInput = document.createElement("input");
    addToCartInput.type = "hidden";
    addToCartInput.name = "add_to_cart";

    form.appendChild(csrfInput);
    form.appendChild(preguntaInput);
    form.appendChild(addToCartInput);

    document.body.appendChild(form);
    form.submit();
}

// Funci√≥n para eliminar pregunta del carrito
function eliminarPregunta(preguntaId) {
    if (!confirm("¬øEst√°s seguro de que deseas eliminar esta pregunta del carrito?")) {
        return;
    }

    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('preguntas', preguntaId);
    formData.append('remove_from_cart', 'true');

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const elemento = document.getElementById(`pregunta-cart-${preguntaId}`);
            if (elemento) {
                elemento.remove();
                
                // Actualizar lista si el carrito queda vac√≠o
                const listaCarrito = document.getElementById('listaCarrito');
                if (listaCarrito.children.length === 0) {
                    listaCarrito.innerHTML = `
                        <li class="list-group-item text-center py-4">
                            <div class="empty-cart-message">
                                <i class="fas fa-shopping-cart text-muted mb-2" style="font-size: 2rem;"></i>
                                <p class="text-muted mb-0">El carrito est√° vac√≠o.</p>
                                <small class="text-muted">Agrega algunas preguntas para comenzar.</small>
                            </div>
                        </li>
                    `;
                }
            }
        } else {
            alert("Error al eliminar la pregunta: " + (data.error || "Error desconocido"));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("Error al comunicarse con el servidor. Por favor intenta nuevamente.");
    });
}

// Funci√≥n para vaciar el carrito
function vaciarCarrito() {
    if (!confirm("¬øEst√°s seguro de que deseas vaciar todo el carrito?")) {
        return;
    }

    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('vaciar_carrito', 'true');

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById("listaCarrito").innerHTML = `
                <li class="list-group-item text-center py-4">
                    <div class="empty-cart-message">
                        <i class="fas fa-shopping-cart text-muted mb-2" style="font-size: 2rem;"></i>
                        <p class="text-muted mb-0">El carrito est√° vac√≠o.</p>
                        <small class="text-muted">Agrega algunas preguntas para comenzar.</small>
                    </div>
                </li>
            `;
        } else {
            alert("Error al vaciar el carrito: " + (data.error || "Error desconocido"));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("Error al comunicarse con el servidor. Por favor intenta nuevamente.");
    });
}

// Inicializaci√≥n cuando el DOM est√° listo
document.addEventListener("DOMContentLoaded", function() {
    // Selecci√≥n m√∫ltiple de preguntas
    const selectAllCheckbox = document.getElementById("selectAll");
    const checkboxes = document.querySelectorAll(".pregunta-checkbox");
    
    // Evento para seleccionar/deseleccionar todas las preguntas
    selectAllCheckbox.addEventListener("change", () => {
        checkboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);
    });
    
    // Evento para verificar si todas est√°n seleccionadas
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener("change", () => {
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
        });
    });

    // Evento para el formulario de examen
    const examenForm = document.getElementById("examenForm");
    examenForm.addEventListener("submit", function(event) {
        const selectedQuestions = Array.from(checkboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.value);

        // Validar si se est√°n a√±adiendo preguntas al carrito
        if (event.submitter.name === "add_to_cart" && selectedQuestions.length === 0) {
            event.preventDefault();
            alert("Por favor, selecciona al menos una pregunta para a√±adir al carrito.");
        }
    });

    // Carga din√°mica de cursos y temas
    const universidadSelect = document.getElementById("universidad");
    const cursoSelect = document.getElementById("curso");
    const temaSelect = document.getElementById("tema");

    // Cargar cursos cuando cambia la universidad
    universidadSelect.addEventListener("change", function() {
        const universidadId = this.value;
        
        // Reiniciar selects
        cursoSelect.innerHTML = '<option value="">Seleccione un curso</option>';
        temaSelect.innerHTML = '<option value="">Seleccione un tema</option>';
        
        if (universidadId) {
            cursoSelect.disabled = true;
            cursoSelect.innerHTML = '<option value="">Cargando...</option>';
            
            fetch(`/preguntas/ajax/load-cursos/?universidad_id=${universidadId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Error al cargar cursos');
                    return response.json();
                })
                .then(data => {
                    cursoSelect.innerHTML = '<option value="">Seleccione un curso</option>';
                    data.forEach(curso => {
                        const option = document.createElement("option");
                        option.value = curso.id;
                        option.textContent = curso.nombre;
                        cursoSelect.appendChild(option);
                    });
                    cursoSelect.disabled = false;
                })
                .catch(error => {
                    console.error("Error:", error);
                    cursoSelect.innerHTML = '<option value="">Error al cargar cursos</option>';
                    cursoSelect.disabled = false;
                });
        }
    });

    // Cargar temas cuando cambia el curso
    cursoSelect.addEventListener("change", function() {
        const cursoId = this.value;
        
        temaSelect.innerHTML = '<option value="">Seleccione un tema</option>';
        
        if (cursoId) {
            temaSelect.disabled = true;
            temaSelect.innerHTML = '<option value="">Cargando...</option>';
            
            fetch(`/preguntas/ajax/load-temas/?curso_id=${cursoId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Error al cargar temas');
                    return response.json();
                })
                .then(data => {
                    temaSelect.innerHTML = '<option value="">Seleccione un tema</option>';
                    data.forEach(tema => {
                        const option = document.createElement("option");
                        option.value = tema.id;
                        option.textContent = tema.nombre;
                        temaSelect.appendChild(option);
                    });
                    temaSelect.disabled = false;
                })
                .catch(error => {
                    console.error("Error:", error);
                    temaSelect.innerHTML = '<option value="">Error al cargar temas</option>';
                    temaSelect.disabled = false;
                });
        }
    });

    // Configurar bot√≥n de a√±adir al carrito desde vista previa
    document.getElementById("btnAgregarCarrito").addEventListener("click", agregarAlCarritoDesdeVistaPrevia);

    // Configurar bot√≥n de vaciar carrito
    document.getElementById("vaciarCarrito").addEventListener("click", vaciarCarrito);

    // Configurar formularios de descarga
    const formCarritoDownload = document.getElementById("formCarritoDownload");
    const formRespuestasDownload = document.getElementById("formRespuestasDownload");

    [formCarritoDownload, formRespuestasDownload].forEach(form => {
        form.addEventListener("submit", function(event) {
            // Limpiar inputs anteriores
            this.querySelectorAll("input[name='preguntas']").forEach(e => e.remove());

            // Obtener preguntas del carrito
            const elementosCarrito = document.querySelectorAll("#listaCarrito li[id^='pregunta-cart-']");

            if (elementosCarrito.length === 0) {
                event.preventDefault();
                alert("No hay preguntas en el carrito para descargar.");
                return;
            }

            // A√±adir preguntas al formulario
            elementosCarrito.forEach(item => {
                const preguntaId = item.id.replace("pregunta-cart-", "");
                if (preguntaId) {
                    const input = document.createElement("input");
                    input.type = "hidden";
                    input.name = "preguntas";
                    input.value = preguntaId;
                    this.appendChild(input);
                }
            });
        });
    });
    
    document.getElementById("cerrarVistaPreviaBtn").addEventListener("click", function () {
        const previewModalEl = document.getElementById("previewModal");
        const previewModal = bootstrap.Modal.getInstance(previewModalEl);
        previewModal.hide();

        // Si se abri√≥ desde el listado y ya est√° en el carrito ‚Üí mostrar carrito
        if (!vistaPreviaDesdeCarrito && preguntaEnCarrito(preguntaIdActual)) {
            const carritoModalEl = document.getElementById("carritoModal");
            const carritoModal = new bootstrap.Modal(carritoModalEl);
            carritoModal.show();
        }
    });
    
    const previewModalEl = document.getElementById("previewModal");
    previewModalEl.addEventListener("hidden.bs.modal", function () {
        if (vistaPreviaDesdeCarrito) {
            const carritoModalEl = document.getElementById("carritoModal");

            // Bootstrap 5: Si ya est√° visible, no es necesario volver a abrir
            const isCarritoVisible = carritoModalEl.classList.contains("show");

            if (!isCarritoVisible) {
                const carritoModal = new bootstrap.Modal(carritoModalEl);
                carritoModal.show();
            }

            // Restaurar el flag para futuras aperturas
            vistaPreviaDesdeCarrito = false;
        }
    });
});
</script>
{% endblock %}