{% extends 'Preguntas/home.html' %}

{% block title %}Generar Examen{% endblock %}

{% block content %}
<main class="container-fluid">
    <section class="card shadow mb-1">
        <header class="card-header text-black ">
            <h1 class="h2 mb-0">
                <i class="fas fa-file-alt me-2"></i>Generar Examen
            </h1>
        </header>
        <div class="card-body">
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
            {% endif %}

            <!-- CARD DE FILTROS -->
            <div class="card mb-4">
                <div class="card-header bg-gradient">
                    <h2 class="h5 mb-0 d-flex align-items-center">
                        <i class="fas fa-filter me-2"></i>Filtros de búsqueda
                    </h2>
                </div>
                <div class="card-body bg-light">
                    <form method="get" id="filtroForm">
                        <div class="row gy-3 gx-3">
                            <!-- UNIVERSIDAD -->
                            <div class="col-sm-6 col-md-4 col-lg-3">
                                <label for="id_universidad" class="form-label fw-bold mb-1">
                                    <i class="fas fa-university me-1 text-primary"></i>Universidad
                                </label>
                                <select name="universidad" id="id_universidad" class="form-select form-select-lx">
                                    <option value="">Todas</option>
                                    {% for uni in form.fields.universidad.queryset %}
                                    <option value="{{ uni.id }}" {% if form.data.universidad|stringformat:"s" == uni.id|stringformat:"s" %}selected{% endif %}>
                                        {{ uni.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- CURSO -->
                            <div class="col-sm-6 col-md-4 col-lg-3">
                                <label for="id_curso" class="form-label fw-bold mb-1">
                                    <i class="fas fa-book me-1 text-primary"></i>Curso
                                </label>
                                <select name="curso" id="id_curso" class="form-select form-select-lx" {% if form.fields.curso.queryset.count == 0 %}disabled{% endif %}>
                                    <option value="">Todos</option>
                                    {% for curso in form.fields.curso.queryset %}
                                    <option value="{{ curso.id }}" {% if form.data.curso|stringformat:"s" == curso.id|stringformat:"s" %}selected{% endif %}>
                                        {{ curso.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- TEMA -->
                            <div class="col-sm-6 col-md-4 col-lg-3">
                                <label for="id_tema" class="form-label fw-bold mb-1">
                                    <i class="fas fa-question-circle me-1 text-primary"></i>Tema
                                </label>
                                <select name="tema" id="id_tema" class="form-select form-select-lx" {% if form.fields.tema.queryset.count == 0 %}disabled{% endif %}>
                                    <option value="">Todos</option>
                                    {% for tema in form.fields.tema.queryset %}
                                    <option value="{{ tema.id }}" {% if form.data.tema|stringformat:"s" == tema.id|stringformat:"s" %}selected{% endif %}>
                                        {{ tema.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- BOTONES DE FILTROS -->
                            <div class="col-sm-6 col-md-4 col-lg-3 d-flex align-items-end">
                                <div class="w-100 d-flex gap-2">
                                    <button type="submit" class="btn btn-primary flex-fill py-2">
                                        <i class="fas fa-filter me-1"></i>Aplicar
                                    </button>
                                    <a href="{% url 'generar-examen' %}"
                                        class="btn btn-outline-secondary flex-fill py-2">
                                        <i class="fas fa-undo me-1"></i>Limpiar
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="row gy-2 gx-2 mt-3">
                            <!-- Añadir al Carrito -->
                            <div class="col-sm-6 col-md-4 col-lg-3">
                                <button type="submit" name="add_to_cart"
                                    class="btn btn-outline-secondary w-100 py-2 align-items-center" form="examenForm">
                                    <i class="fas fa-cart-plus fs-5 mb-1"></i>
                                    <span class="fw-semibold">Añadir al Carrito</span>
                                </button>
                            </div>
                            <!-- Ver Carrito -->
                            <div class="col-sm-6 col-md-4 col-lg-3">
                                <button type="button"
                                    class="btn btn-outline-info w-100 py-2 d-flex align-items-center justify-content-center"
                                    data-bs-toggle="modal" data-bs-target="#carritoModal">
                                    <i class="fas fa-shopping-cart fs-5"></i>
                                    <span class="badge bg-warning text-dark ms-2">{{ carrito.count }}</span>
                                    <span class="fw-semibold ms-3">Ver Carrito</span>
                                </button>
                            </div>
                            <!-- Descargar Examen -->
                            <div class="col-sm-6 col-md-4 col-lg-3">
                                <button type="submit" name="download"
                                    class="btn btn-outline-success w-100 py-2 align-items-center" form="examenForm">
                                    <i class="fas fa-download fs-5 mb-1"></i>
                                    <span class="fw-semibold">Descargar Examen</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Listado de Preguntas -->
                <form method="post" id="examenForm">
                    {% csrf_token %}
                    <div class="table-responsive mt-4" style="overflow-x: auto;">
                        <table class="table table-striped table-bordered table-hover align-middle" style="width: 100%;">
                            <caption class="visually-hidden">
                                Listado de {{ preguntas.count }} preguntas disponibles
                            </caption>
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th scope="col" class="text-center" style="width: 40px;">
                                        <div class="form-check">
                                            <input type="checkbox" id="selectAll" class="form-check-input"
                                                aria-label="Seleccionar todas las preguntas">
                                            <label class="form-check-label visually-hidden" for="selectAll">Seleccionar todo</label>
                                        </div>
                                    </th>
                                    <th scope="col" style="width: 100px;" class="ps-3">
                                        <span class="fw-bold"><i class="fas fa-hashtag me-1"></i> Código</span>
                                    </th>
                                    <th scope="col" style="width: 100px;" class="ps-3">
                                        <span class="fw-bold"><i class="fas fa-clock me-1"></i> Estado</span>
                                    </th>
                                    <th scope="col" style="width: 150px;" class="ps-3">
                                        <span class="fw-bold"><i class="fas fa-university me-1"></i> Universidad</span>
                                    </th>
                                    <th scope="col" style="width: 100px;" class="ps-3">
                                        <span class="fw-bold"><i class="fas fa-book me-1"></i> Curso</span>
                                    </th>
                                    <th scope="col" style="width: 150px;" class="ps-3">
                                        <span class="fw-bold"><i class="fas fa-question-circle me-1"></i> Tema</span>
                                    </th>
                                    <th scope="col" style="width: 100px;" class="ps-3">
                                        <span class="fw-bold"><i class="fas fa-layer-group me-1"></i> Nivel</span>
                                    </th>
                                    <th scope="col" style="width: 110px;" class="text-center">
                                        <span class="fw-bold"><i class="fas fa-calendar me-1"></i> Fecha</span>
                                    </th>
                                    <th scope="col" style="width: 120px;" class="text-center">
                                        <span class="fw-bold"><i class="fas fa-cogs me-1"></i> Acciones</span>
                                    </th>
                                    <th scope="col" style="width: 120px;" class="text-center">
                                        <span class="fw-bold"><i class="fas fa-check-circle me-1"></i> Solución</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pregunta in page_obj.object_list %}
                                <tr class="{% if pregunta.is_usada %}table-warning{% endif %}">
                                    <!-- Checkbox -->
                                    <td class="text-center align-middle">
                                        <div class="form-check">
                                            <input type="checkbox" id="pregunta-{{ pregunta.id }}" name="preguntas"
                                                value="{{ pregunta.id }}" class="pregunta-checkbox form-check-input"
                                                aria-label="Seleccionar pregunta {{ pregunta.nombre }}">
                                            <label class="form-check-label visually-hidden"
                                                for="pregunta-{{ pregunta.id }}">
                                                Seleccionar {{ pregunta.nombre }}
                                            </label>
                                        </div>
                                    </td>
                                    <!-- Código -->
                                    <td class="align-middle ps-3">
                                        <strong class="text-primary fw-bold">{{ pregunta.nombre }}</strong>
                                    </td>
                                    <!-- Estado -->
                                    <td class="align-middle">
                                        {% if pregunta.is_usada %}
                                        <span
                                            class="badge bg-warning text-dark d-inline-flex align-items-center fw-semibold"
                                            title="Pregunta usada en examen previo el {{ pregunta.fecha_ultimo_uso|date:'d/m/Y H:i' }}">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <div class="text-start">
                                                <div>Usada el:</div>
                                                <small class="fw-normal">{{ pregunta.fecha_ultimo_uso|date:'d/m/Y H:i'}}</small>
                                            </div>
                                        </span>
                                        {% else %}
                                        <span
                                            class="badge bg-success text-white d-inline-flex align-items-center fw-semibold"
                                            title="Pregunta no usada en ningún examen">
                                            <i class="fas fa-check-circle me-1"></i>
                                            Sin Uso
                                        </span>
                                        {% endif %}
                                    </td>
                                    <!-- Universidad -->
                                    <td class="align-middle ps-3">
                                        <div class="fw-bold text-truncate" title="{{ pregunta.universidad.nombre }}">
                                            {{ pregunta.universidad.nombre }}
                                        </div>
                                        <small class="text-muted fw-normal">ID: {{ pregunta.universidad.id }}</small>
                                    </td>
                                    <!-- Curso -->
                                    <td class="align-middle ps-3">
                                        <div class="fw-bold text-truncate" title="{{ pregunta.curso.nombre }}">
                                            {{ pregunta.curso.nombre }}
                                        </div>
                                        <small class="text-muted fw-normal">ID: {{ pregunta.curso.id }}</small>
                                    </td>
                                    <!-- Tema -->
                                    <td class="align-middle ps-3">
                                        <div class="fw-bold text-truncate" title="{{ pregunta.tema.nombre }}">
                                            {{ pregunta.tema.nombre }}
                                        </div>
                                        <small class="text-muted fw-normal">ID: {{ pregunta.tema.id }}</small>
                                    </td>
                                    <!-- Nivel -->
                                    <td class="align-middle ps-3">
                                        <div class="d-flex align-items-center">
                                            <span class="badge fw-bold
                                                {% if pregunta.nivel == 1 %}bg-success
                                                {% elif pregunta.nivel == 2 %}bg-warning text-dark
                                                {% elif pregunta.nivel == 3 %}bg-danger
                                                {% else %}bg-secondary{% endif %}">
                                                {% if pregunta.nivel == 1 %}1 - Bajo
                                                {% elif pregunta.nivel == 2 %}2 - Medio
                                                {% elif pregunta.nivel == 3 %}3 - Alto
                                                {% else %}Desconocido{% endif %}
                                            </span>
                                        </div>
                                    </td>
                                    <!-- Fecha -->
                                    <td class="align-middle text-center">
                                        <div class="fw-bold">
                                            {{ pregunta.fecha_creacion|date:"d/m/Y" }}
                                        </div>
                                        <span class="fw-semibold">
                                            {% if pregunta.fecha_expiracion > now %}
                                            <span class="countdown-timer text-success"
                                                data-expiration="{{ pregunta.fecha_expiracion|date:'Y-m-d H:i:s' }}"
                                                title="Expira: {{ pregunta.fecha_expiracion|date:'d M Y H:i' }}">
                                                <i class="fas fa-clock me-1" aria-hidden="true"></i>
                                                <span class="time-remaining">
                                                    {% with tiempo_restante=pregunta.fecha_expiracion|timeuntil:now %}
                                                    {% if "hour" in tiempo_restante %}
                                                    {{ tiempo_restante|slice:":2"|cut:" " }} H
                                                    {% if "minute" in tiempo_restante %}
                                                    {{ tiempo_restante|slice:"9:11"|cut:" " }} m
                                                    {% endif %}
                                                    {% else %}
                                                    {{ tiempo_restante|slice:":2"|cut:" " }} m
                                                    {% endif %}
                                                    {% endwith %}
                                                </span>
                                            </span>
                                            {% else %}
                                            <span class="text-danger"
                                                title="Expirada: {{ pregunta.fecha_expiracion|date:'d M Y H:i' }}">
                                                <i class="fas fa-clock me-1" aria-hidden="true"></i>
                                                Expirada
                                            </span>
                                            {% endif %}
                                        </span>
                                    </td>
                                    <!-- Acciones -->
                                    <td>
                                        <div class="d-flex justify-content-center gap-2"
                                            aria-label="Acciones para pregunta {{ pregunta.nombre }}">
                                            <button type="button" class="btn btn-info btn-sm px-2 py-1"
                                                data-url="{% url 'vista-previa' pregunta.id %}"
                                                data-pregunta-id="{{ pregunta.id }}" data-bs-toggle="modal"
                                                data-bs-target="#previewModal" onclick="loadPdfPreview(this)"
                                                data-bs-toggle="tooltip" data-bs-title="Vista previa">
                                                <i class="fas fa-eye" aria-hidden="true"></i>
                                                <span class="visually-hidden">Vista previa</span>
                                            </button>
                                            <a href="{% url 'pregunta-update' pregunta.id %}"
                                                class="btn btn-warning btn-sm px-2 py-1" data-bs-toggle="tooltip"
                                                data-bs-title="Editar">
                                                <i class="fas fa-pencil-alt" aria-hidden="true"></i>
                                                <span class="visually-hidden">Editar</span>
                                            </a>
                                        </div>
                                    </td>
                                    <!-- Edición rápida de Solución y Alternativa -->
                                        <td class="align-middle text-center">
                                            <form class="form-update-rapida d-flex flex-column align-items-center" data-id="{{ pregunta.id }}">
                                                <div class="form-check form-switch mb-1">
                                                    <input class="form-check-input tiene-solucion-checkbox" type="checkbox" 
                                                        {% if pregunta.tiene_solucion %}checked{% endif %}
                                                        id="solucion-{{ pregunta.id }}">
                                                    <label class="form-check-label small" for="solucion-{{ pregunta.id }}">¿Sol?</label>
                                                </div>
                                                <select class="form-select form-select-sm alternativa-select mb-1" style="width: 80px;"
                                                    id="alternativa-{{ pregunta.id }}">
                                                    {% for letra in "ABCDE" %}
                                                    <option value="{{ letra }}" {% if pregunta.respuesta == letra %}selected{% endif %}>{{ letra }}</option>
                                                    {% endfor %}
                                                </select>
                                                <button type="button" class="btn btn-sm btn-success guardar-cambios-btn" 
                                                    id="guardar-{{ pregunta.id }}">
                                                    <i class="fas fa-save"></i>
                                                </button>
                                            </form>
                                        </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="10" class="text-center py-5">
                                        <div class="text-muted">
                                            <i class="fas fa-search fa-3x mb-3 d-block"></i>
                                            <h3 class="h5 fw-bold">No se encontraron preguntas</h3>
                                            <p class="mb-0 fw-normal">Prueba ajustando los filtros de búsqueda o <a
                                                    href="{% url 'generar-examen' %}"
                                                    class="text-decoration-none fw-semibold">limpia los filtros</a> para ver todas las preguntas.</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if preguntas %}
                    <div
                        class="d-flex flex-column flex-lg-row justify-content-between align-items-center p-3 bg-light rounded gap-3">
                        <div class="text-muted text-center text-lg-start fw-semibold">
                            <i class="fas fa-info-circle me-1"></i>
                            Mostrando <span class="fw-bold">{{ preguntas.count }}</span> pregunta{{ preguntas.count|pluralize }}
                            {% if carrito.count > 0 %}
                            | <span class="fw-bold">{{ carrito.count }}</span> en el carrito
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span class="text-muted fw-semibold">
                                Mostrando preguntas {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ page_obj.paginator.count }}
                            </span>
                        </div>
                        <nav aria-label="Paginación de preguntas">
                            <ul class="pagination mb-0">
                                {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link fw-semibold"
                                        href="?page=1{% if universidad_filter %}&universidad={{ universidad_filter }}{% endif %}{% if curso_filter %}&curso={{ curso_filter }}{% endif %}{% if tema_filter %}&tema={{ tema_filter }}{% endif %}"
                                        aria-label="Primera">
                                        <span aria-hidden="true">&laquo;&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link fw-semibold"
                                        href="?page={{ page_obj.previous_page_number }}{% if universidad_filter %}&universidad={{ universidad_filter }}{% endif %}{% if curso_filter %}&curso={{ curso_filter }}{% endif %}{% if tema_filter %}&tema={{ tema_filter }}{% endif %}"
                                        aria-label="Anterior">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                {% endif %}
                                {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                <li class="page-item active" aria-current="page">
                                    <span class="page-link fw-bold">{{ num }}</span>
                                </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <li
                                    class="page-item">
                                    <a class="page-link fw-semibold"
                                        href="?page={{ num }}{% if universidad_filter %}&universidad={{ universidad_filter }}{% endif %}{% if curso_filter %}&curso={{ curso_filter }}{% endif %}{% if tema_filter %}&tema={{ tema_filter }}{% endif %}">
                                        {{ num }}
                                    </a>
                                    </li>
                                    {% endif %}
                                    {% endfor %}

                                    {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link fw-semibold"
                                            href="?page={{ page_obj.next_page_number }}{% if universidad_filter %}&universidad={{ universidad_filter }}{% endif %}{% if curso_filter %}&curso={{ curso_filter }}{% endif %}{% if tema_filter %}&tema={{ tema_filter }}{% endif %}"
                                            aria-label="Siguiente">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link fw-semibold"
                                            href="?page={{ page_obj.paginator.num_pages }}{% if universidad_filter %}&universidad={{ universidad_filter }}{% endif %}{% if curso_filter %}&curso={{ curso_filter }}{% endif %}{% if tema_filter %}&tema={{ tema_filter }}{% endif %}"
                                            aria-label="Última">
                                            <span aria-hidden="true">&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                    {% endif %}
                            </ul>
                        </nav>
                    </div>
                </form>
            </div>
    </section>
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Notificación</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>
</main>
<!-- Modal de la vista previa en pdf-->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Vista previa de la pregunta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Vista previa en iframe -->
                <iframe id="previewFrame" src="" width="100%" height="700px" frameborder="0"></iframe>
            </div>
            <div class="modal-footer">
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <button id="btnAgregarCarrito" class="btn btn-success">
                    <i class="fas fa-cart-plus me-1"></i>Añadir al Carrito
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal del Carrito -->
<div class="modal fade" id="carritoModal" tabindex="-1" aria-labelledby="carritoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-5" id="carritoModalLabel">
                    <i class="fas fa-shopping-cart me-2"></i>Carrito de Preguntas
                </h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 120px;">Código</th>
                                <th style="width: 200px;">Universidad</th>
                                <th style="width: 180px;">Curso</th>
                                <th style="width: 160px;">Tema</th>
                                <th style="width: 100px;" class="text-center">Nivel</th>
                                <th style="width: 120px;" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="listaCarrito">
                            {% for pregunta in carrito %}
                            <tr id="pregunta-cart-{{ pregunta.id }}">
                                <td><strong class="text-primary">{{ pregunta.nombre }}</strong></td>
                                <td>
                                    <div class="fw-semibold">{{ pregunta.universidad.nombre }}</div>
                                </td>
                                <td>
                                    <div class="fw-semibold">{{ pregunta.curso.nombre }}</div>
                                </td>
                                <td>
                                    <div class="fw-semibold">{{ pregunta.tema.nombre }}</div>
                                </td>
                                <td class="text-center">
                                    <span class="badge fs-6 px-2 py-1
                                        {% if pregunta.nivel == 1 %}bg-success
                                        {% elif pregunta.nivel == 2 %}bg-warning text-dark
                                        {% elif pregunta.nivel == 3 %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {% if pregunta.nivel == 1 %}Básico
                                        {% elif pregunta.nivel == 2 %}Intermedio
                                        {% elif pregunta.nivel == 3 %}Avanzado
                                        {% else %}N/A{% endif %}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-info btn-sm"
                                            data-url="{% url 'vista-previa' pregunta.id %}"
                                            data-pregunta-id="{{ pregunta.id }}" data-bs-toggle="modal"
                                            data-bs-target="#previewModal" onclick="loadPdfPreview(this)"
                                            title="Vista previa">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-danger btn-sm"
                                            onclick="eliminarPregunta('{{ pregunta.id }}')"
                                            title="Eliminar del carrito">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-5">
                                    <div class="empty-cart-message">
                                        <i class="fas fa-shopping-cart text-muted mb-3" style="font-size: 3rem;"></i>
                                        <h4 class="text-muted mb-2">El carrito está vacío</h4>
                                        <p class="text-muted mb-0">Agrega algunas preguntas para comenzar a crear tu examen.</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer d-flex flex-wrap gap-2 justify-content-between">
                <button type="button" class="btn btn-danger" id="vaciarCarrito">
                    <i class="fas fa-trash me-1"></i>Vaciar Carrito
                </button>
                <div class="d-flex gap-2">
                    <form method="post" id="formCarritoDownload" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="download" value="true">
                        <button type="submit" name="download" class="btn btn-success" form="examenForm"
                            title="Descargar examen con preguntas del carrito">
                            <i class="fas fa-download me-1"></i> Descargar Examen
                        </button>
                    </form>
                    <form method="post" id="formRespuestasDownload" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="download_respuestas" value="true">
                        <button type="submit" name="download_respuestas" class="btn btn-outline-success"
                            form="examenForm">
                            <i class="fas fa-file-excel me-1"></i>Descargar Respuestas
                        </button>
                    </form>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// Variables globales
let preguntaIdActual = null;
let vistaPreviaDesdeCarrito = false;

// Función para cargar la vista previa del PDF
function loadPdfPreview(button) {
    const url = button.getAttribute('data-url');
    const iframe = document.getElementById('previewFrame');
    iframe.src = url;

    preguntaIdActual = button.getAttribute('data-pregunta-id');

    const btnAgregarCarrito = document.getElementById("btnAgregarCarrito");
    if (preguntaEnCarrito(preguntaIdActual)) {
        btnAgregarCarrito.disabled = true;
        btnAgregarCarrito.innerHTML = '<i class="fas fa-check me-1"></i> Ya en el carrito';
        btnAgregarCarrito.classList.remove('btn-success');
        btnAgregarCarrito.classList.add('btn-secondary');
    } else {
        btnAgregarCarrito.disabled = false;
        btnAgregarCarrito.innerHTML = '<i class="fas fa-cart-plus me-1"></i> Añadir al Carrito';
        btnAgregarCarrito.classList.remove('btn-secondary');
        btnAgregarCarrito.classList.add('btn-success');
    }
}

// Función para verificar si una pregunta está en el carrito
function preguntaEnCarrito(preguntaId) {
    return document.querySelector(`#pregunta-cart-${preguntaId}`) !== null;
}

// Función para añadir pregunta al carrito desde la vista previa
async function agregarAlCarritoDesdeVistaPrevia() {
    if (!preguntaIdActual) return;

    try {
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const response = await fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new URLSearchParams({
                'csrfmiddlewaretoken': csrftoken,
                'pregunta_id': preguntaIdActual,
                'add_preview': 'true'
            })
        });

        const data = await response.json();

        if (data.success) {
            // Actualizar UI del botón
            const btnAgregarCarrito = document.getElementById("btnAgregarCarrito");
            btnAgregarCarrito.disabled = true;
            btnAgregarCarrito.innerHTML = '<i class="fas fa-check me-1"></i> Ya en el carrito';
            btnAgregarCarrito.classList.remove('btn-success');
            btnAgregarCarrito.classList.add('btn-secondary');

            // Actualizar contador del carrito
            const badge = document.querySelector('.badge.bg-warning.text-dark');
            if (badge) {
                const currentCount = parseInt(badge.textContent) || 0;
                badge.textContent = currentCount + 1;
            }

            // Mostrar notificación con Toast de Bootstrap
            const toast = new bootstrap.Toast(document.getElementById('liveToast'));
            document.getElementById('toastMessage').textContent = 'Pregunta añadida al carrito correctamente';
            toast.show();
        } else {
            alert('Error al añadir la pregunta: ' + (data.error || 'Error desconocido'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error de conexión al servidor');
    }
}

// Función para eliminar pregunta del carrito
function eliminarPregunta(preguntaId) {
    if (!confirm("¿Estás seguro de que deseas eliminar esta pregunta del carrito?")) {
        return;
    }

    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('preguntas', preguntaId);
    formData.append('remove_from_cart', 'true');

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const elemento = document.getElementById(`pregunta-cart-${preguntaId}`);
                if (elemento) {
                    elemento.remove();

                    // Actualizar lista si el carrito queda vacío
                    const listaCarrito = document.getElementById('listaCarrito');
                    if (listaCarrito.children.length === 0) {
                        listaCarrito.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="empty-cart-message">
                                    <i class="fas fa-shopping-cart text-muted mb-3" style="font-size: 3rem;"></i>
                                    <h4 class="text-muted mb-2">El carrito está vacío</h4>
                                    <p class="text-muted mb-0">Agrega algunas preguntas para comenzar a crear tu examen.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    }
                }
            } else {
                alert("Error al eliminar la pregunta: " + (data.error || "Error desconocido"));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error al comunicarse con el servidor. Por favor intenta nuevamente.");
        });
}

// Función para vaciar el carrito
function vaciarCarrito() {
    if (!confirm("¿Estás seguro de que deseas vaciar todo el carrito?")) {
        return;
    }

    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('vaciar_carrito', 'true');

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById("listaCarrito").innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <div class="empty-cart-message">
                            <i class="fas fa-shopping-cart text-muted mb-3" style="font-size: 3rem;"></i>
                            <h4 class="text-muted mb-2">El carrito está vacío</h4>
                            <p class="text-muted mb-0">Agrega algunas preguntas para comenzar a crear tu examen.</p>
                        </div>
                    </td>
                </tr>
            `;
            } else {
                alert("Error al vaciar el carrito: " + (data.error || "Error desconocido"));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error al comunicarse con el servidor. Por favor intenta nuevamente.");
        });
}

// Función para configurar los listeners de un formulario
function setupFormListener(form) {
    const boton = form.querySelector('.guardar-cambios-btn');
    if (!boton) {
        console.error('No se encontró el botón en el formulario:', form);
        return;
    }

    // Remover cualquier listener previo para evitar duplicados
    boton.removeEventListener('click', handleGuardarCambios);
    
    // Agregar el nuevo listener
    boton.addEventListener('click', handleGuardarCambios);

    function handleGuardarCambios() {
        const formData = new FormData();
        formData.append('id', form.dataset.id);
        formData.append('tiene_solucion', form.querySelector('.tiene-solucion-checkbox').checked);
        formData.append('alternativa', form.querySelector('.alternativa-select').value);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        // Mostrar loading
        const originalHTML = boton.innerHTML;
        boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        boton.disabled = true;

        fetch("{% url 'actualizar-rapido-pregunta' %}", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Cambios guardados correctamente');
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión');
        })
        .finally(() => {
            boton.innerHTML = originalHTML;
            boton.disabled = false;
        });
    }
}

function showToast(message) {
    const toast = new bootstrap.Toast(document.getElementById('liveToast'));
    document.getElementById('toastMessage').textContent = message;
    toast.show();
}

// Función para actualizar los contadores de tiempo
function updateCountdowns() {
    const timers = document.querySelectorAll('.countdown-timer');

    timers.forEach(timer => {
        const expirationDate = new Date(timer.dataset.expiration);
        const now = new Date();
        const diff = expirationDate - now;

        if (diff <= 0) {
            // Cambiar a estado "Expirada"
            timer.innerHTML = '<i class="fas fa-clock me-1" aria-hidden="true"></i> Expirada';
            timer.classList.remove('text-success');
            timer.classList.add('text-danger');
            timer.title = 'Expirada: ' + timer.dataset.expiration;
            return;
        }

        // Calcular horas y minutos
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        // Formatear como "X H Y min"
        let timeStr = '';
        if (hours > 0) {
            timeStr += hours + ' H ';
            if (minutes > 0) {
                timeStr += minutes + ' m';
            }
        } else {
            timeStr += minutes + ' m';
        }

        // Actualizar el elemento manteniendo el icono
        timer.querySelector('.time-remaining').textContent = timeStr.trim();
    });
}

// Filtros jerárquicos: cargar cursos y temas dinámicamente
function setupHierarchicalFilters() {
    const universidadSelect = document.getElementById("id_universidad");
    const cursoSelect = document.getElementById("id_curso");
    const temaSelect = document.getElementById("id_tema");

    if (!universidadSelect || !cursoSelect || !temaSelect) return;

    universidadSelect.addEventListener("change", function () {
        const universidadId = this.value;
        cursoSelect.innerHTML = '<option value="">Todos los cursos</option>';
        temaSelect.innerHTML = '<option value="">Todos los temas</option>';
        temaSelect.disabled = true;

        if (!universidadId) {
            cursoSelect.disabled = true;
            return;
        }

        cursoSelect.disabled = true;
        cursoSelect.innerHTML = '<option>Cargando cursos...</option>';

        fetch(`/preguntas/ajax/load-cursos/?universidad_id=${universidadId}`)
            .then(response => response.json())
            .then(data => {
                cursoSelect.innerHTML = '<option value="">Todos los cursos</option>';
                data.forEach(curso => {
                    const option = document.createElement("option");
                    option.value = curso.id;
                    option.textContent = curso.nombre;
                    cursoSelect.appendChild(option);
                });
                cursoSelect.disabled = false;
            })
            .catch(() => {
                cursoSelect.innerHTML = '<option>Error al cargar cursos</option>';
                cursoSelect.disabled = false;
            });
    });

    cursoSelect.addEventListener("change", function () {
        const cursoId = this.value;
        temaSelect.innerHTML = '<option value="">Todos los temas</option>';

        if (!cursoId) {
            temaSelect.disabled = true;
            return;
        }

        temaSelect.disabled = true;
        temaSelect.innerHTML = '<option>Cargando temas...</option>';

        fetch(`/preguntas/ajax/load-temas/?curso_id=${cursoId}`)
            .then(response => response.json())
            .then(data => {
                temaSelect.innerHTML = '<option value="">Todos los temas</option>';
                data.forEach(tema => {
                    const option = document.createElement("option");
                    option.value = tema.id;
                    option.textContent = tema.nombre;
                    temaSelect.appendChild(option);
                });
                temaSelect.disabled = false;
            })
            .catch(() => {
                temaSelect.innerHTML = '<option>Error al cargar temas</option>';
                temaSelect.disabled = false;
            });
    });

    if (!universidadSelect.value) {
        cursoSelect.disabled = true;
        temaSelect.disabled = true;
    } else if (!cursoSelect.value) {
        temaSelect.disabled = true;
    }
}

// Inicialización cuando el DOM está listo
document.addEventListener("DOMContentLoaded", function () {
    // Selección múltiple de preguntas
    const selectAllCheckbox = document.getElementById("selectAll");
    if (selectAllCheckbox) {
        const checkboxes = document.querySelectorAll(".pregunta-checkbox");
        
        // Evento para seleccionar/deseleccionar todas las preguntas
        selectAllCheckbox.addEventListener("change", () => {
            checkboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);
        });

        // Evento para verificar si todas están seleccionadas
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener("change", () => {
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
            });
        });
    }

    // Configurar botón de añadir al carrito desde vista previa
    const botonAgregar = document.getElementById("btnAgregarCarrito");
    if (botonAgregar) {
        botonAgregar.addEventListener("click", agregarAlCarritoDesdeVistaPrevia);
    }

    // Configurar botón de vaciar carrito
    const vaciarBtn = document.getElementById("vaciarCarrito");
    if (vaciarBtn) {
        vaciarBtn.addEventListener("click", vaciarCarrito);
    }

    // Configurar formularios de descarga
    const formCarritoDownload = document.getElementById("formCarritoDownload");
    const formRespuestasDownload = document.getElementById("formRespuestasDownload");

    [formCarritoDownload, formRespuestasDownload].forEach(form => {
        if (!form) return;
        form.addEventListener("submit", function (event) {
            // Limpiar inputs anteriores
            this.querySelectorAll("input[name='preguntas']").forEach(e => e.remove());

            // Obtener preguntas del carrito
            const elementosCarrito = document.querySelectorAll("#listaCarrito tr[id^='pregunta-cart-']");

            if (elementosCarrito.length === 0) {
                event.preventDefault();
                alert("No hay preguntas en el carrito para descargar.");
                return;
            }

            // Añadir preguntas al formulario
            elementosCarrito.forEach(item => {
                const preguntaId = item.id.replace("pregunta-cart-", "");
                if (preguntaId) {
                    const input = document.createElement("input");
                    input.type = "hidden";
                    input.name = "preguntas";
                    input.value = preguntaId;
                    this.appendChild(input);
                }
            });
        });
    });

    // Configurar todos los formularios iniciales
    const forms = document.querySelectorAll('.form-update-rapida');
    console.log('Formularios encontrados:', forms.length); // Para depuración
    
    forms.forEach((form, index) => {
        console.log(`Configurando formulario ${index + 1}`, form); // Para depuración
        setupFormListener(form);
    });
    // Observador de mutaciones para nuevos elementos dinámicos
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) {
                    // Buscar formularios en el nodo añadido y en sus descendientes
                    const newForms = node.matches('.form-update-rapida') ? 
                        [node] : 
                        Array.from(node.querySelectorAll('.form-update-rapida'));
                    
                    newForms.forEach(newForm => {
                        console.log('Nuevo formulario detectado:', newForm); // Para depuración
                        setupFormListener(newForm);
                    });
                }
            });
        });
    });

    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    // Configurar filtros jerárquicos
    setupHierarchicalFilters();

    // Configurar contadores de tiempo
    updateCountdowns();
    setInterval(updateCountdowns, 60000);

    // Eventos para los modales
    const previewModalEl = document.getElementById("previewModal");
    if (previewModalEl) {
        previewModalEl.addEventListener("hidden.bs.modal", function () {
            if (vistaPreviaDesdeCarrito) {
                const carritoModalEl = document.getElementById("carritoModal");
                const isCarritoVisible = carritoModalEl.classList.contains("show");
                if (!isCarritoVisible) {
                    const carritoModal = new bootstrap.Modal(carritoModalEl);
                    carritoModal.show();
                }
                vistaPreviaDesdeCarrito = false;
            }
        });
    }
});
</script>
{% endblock %}